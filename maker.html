<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Problem Maker</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css" />
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
</head>
<body>
  <h1>Problem Maker</h1>

  <h1>Problem Input</h1>
  <div><textarea id="problem-input" style="width: 100%; height: 100px;"></textarea></div>
  <div><button id="problem-load-button" type="button">Load</button></div>

  <hr />
  
  <div>
    <div>
      title: <input type="text" name="title" />
    </div>
    <div id="content-editor"></div>

    <h2>Test Cases <button id="test-case-add-button" type="button">Add</button></h2>
    <ol id="test-case-list"></ol>

    <h2>Solution</h2>
    <div id="editor" style="width: 600px; height: 400px; border: 1px solid black;"></div>
    <div><button id="run-button" type="button">Run</button></div>

    <h3>Solution Result</h3>
    <textarea id="solution-result" readonly style="width: 500px; height: 200px;"></textarea>

    <div>
      <button id="problem-make-button" type="button">Make</button>
    </div>
  </div>

  <hr />

  <h1>Problem Output</h2>
  <div><textarea id="problem-output" readonly style="width: 100%; height: 100px;"></textarea></div>

  <script src="jquery-3.5.1.min.js"></script>
  <script src="https://uicdn.toast.com/editor/latest/toastui-jquery-editor.min.js"></script>
  <script src="vs/loader.js"></script>
  <script>
    $(function()
    {
      $('#content-editor').toastuiEditor({
        height: '500px',
        initialEditType: 'markdown',
        previewStyle: 'vertical'
      });

      let editor;
      require.config({ paths: { vs: 'vs' } });
      require(['vs/editor/editor.main'], function()
      {
        editor = monaco.editor.create(
          document.getElementById('editor'),
          {
            language: 'javascript'
          }
        )
      });

      function addTextCase(input, output)
      {
        const $ol = $('#test-case-list');
        const $li = $(`
        <li>
          <textarea class="input" style="width: 400px; height: 100px;">${input??''}</textarea>
          <textarea class="output" style="width: 400px; height: 100px;">${output??''}</textarea>
        </li>
        `);
        const $removeButton = $('<button type="button">remove</button>');
        $removeButton.click(function()
        {
          $(this).parent().remove();
        });
        $li.append($removeButton);
        $ol.append($li);
      }

      $('#test-case-add-button').click(function()
      {
        addTextCase();
      });

      $('#run-button').click(function()
      {
        if ($('#test-case-list li').length === 0)
        {
          alert('no test cases');
          return;
        }

        const testCases = $('#test-case-list li').map((i,li) => ({ input: $(li).find('.input').val().trimEnd(), output: $(li).find('.output').val().trimEnd() })).toArray();
        const code = editor.getValue();
        let solutionResult = '';

        for (let i = 0; i < testCases.length; i++)
        {
          const testCase = testCases[i];
          const testCaseNumber = i + 1;
          let output = '';
          
          const inputs = testCase.input.split(/\r+\n/);
          let currentInputIndex = -1;
          function readline()
          {
            if (++currentInputIndex < inputs.length)
            {
              return inputs[currentInputIndex];
            }

            return '';
          }

          function print(msg)
          {
            output += msg.toString() + '\n';
          }
          
          const editedCode = code
            .replace(/(?<!\.)readline/, 'arguments[0]')
            .replace(/(?<!\.)print/, 'arguments[1]');
          const codeFunction = new Function(editedCode);
          solutionResult += `--- TestCase #${testCaseNumber} ---\n`;
          try
          {
            codeFunction.apply(null, [readline, print]);
          }
          catch(e)
          {
            solutionResult += 'Failed.\n';
            solutionResult += e.toString();
            break;
          }

          output = output.trimEnd();
          if (output == testCase.output)
          {
            solutionResult += 'Success.\n\n';
          }
          else
          {
            solutionResult += 'We expected...\n';
            solutionResult += testCase.output;
            solutionResult += '\nBut Your answer is...\n';
            solutionResult += output ? output : "'#empty'";
            break;
          }
        }

        $('#solution-result').val(solutionResult);
      });

      $('#problem-load-button').click(function()
      {
        const json = $('#problem-input').val();
        const problem = JSON.parse(json);
        
        $('input[name=title]').val(problem.title??'');
        $('#content-editor').toastuiEditor('setMarkdown', problem.content??'');
        problem.testCases.forEach(testCase =>
        {
          addTextCase(testCase.input, testCase.output);
        });
        editor.setValue(problem.solution??'');
      })

      $('#problem-make-button').click(function()
      {
        const problem = {
          title: $('input[name=title]').val(),
          content: $('#content-editor').toastuiEditor('getMarkdown'),
          testCases: $('#test-case-list li').map((i,li) => ({ input: $(li).find('.input').val().trimEnd(), output: $(li).find('.output').val().trimEnd() })).toArray(),
          solution: editor.getValue()
        };
        $('#problem-output').val(JSON.stringify(problem));
      })

      window.addEventListener('beforeunload', function(e)
      {
        e.preventDefault();
        e.returnValue = '';
      });
    })();
  </script>
</body>
</html>