<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Problem Maker</title>

  <link rel="stylesheet" href="toast/codemirror.min.css" />
  <link rel="stylesheet" href="toast/toastui-editor.min.css" />
</head>
<body>
  <h1>Problem Maker</h1>

  <h1>Problem Input</h1>
  <div><textarea id="problem-input" style="width: 100%; height: 100px;"></textarea></div>
  <div><button id="problem-load-button" type="button">Load</button></div>

  <hr />
  
  <div>
    <div>
      title: <input type="text" name="title" />
    </div>
    <div id="content-editor"></div>

    <h2>Open Test Cases <button id="open-test-case-add-button" type="button">Add</button></h2>
    <ol id="open-test-case-list"></ol>

    <h2>Random Test Cases</h2>
    <div id="random-test-case-editor" style="width: 600px; height: 400px; border: 1px solid black;"></div>

    <h2>Solution</h2>
    <div id="solution-editor" style="width: 600px; height: 400px; border: 1px solid black;"></div>
    <div><button id="run-button" type="button">Run</button></div>

    <h3>Solution Result</h3>
    <textarea id="solution-result" readonly style="width: 500px; height: 200px;"></textarea>

    <div>
      <button id="problem-make-button" type="button">Make</button>
    </div>
  </div>

  <hr />

  <h1>Problem Output</h2>
  <div><textarea id="problem-output" readonly style="width: 100%; height: 100px;"></textarea></div>

  <script src="jquery-3.5.1.min.js"></script>
  <script src="toast/toastui-jquery-editor.min.js"></script>
  <script src="vs/loader.js"></script>
  <script>
    $(function()
    {
      $('#content-editor').toastuiEditor({
        height: '500px',
        initialEditType: 'markdown',
        previewStyle: 'vertical'
      });

      let solutionEditor;
      let randomTestCaseEditor;
      require.config({ paths: { vs: 'vs' } });
      require(['vs/editor/editor.main'], function()
      {
        solutionEditor = monaco.editor.create(
          document.getElementById('solution-editor'),
          {
            language: 'javascript'
          }
        );
        randomTestCaseEditor = monaco.editor.create(
          document.getElementById('random-test-case-editor'),
          {
            language: 'javascript'
          }
        );
      });

      function addOpenTestCase(input, output)
      {
        const $ol = $('#open-test-case-list');
        const $li = $(`
        <li>
          <textarea class="input" style="width: 400px; height: 100px;">${input??''}</textarea>
          <textarea class="output" style="width: 400px; height: 100px;">${output??''}</textarea>
        </li>
        `);
        const $removeButton = $('<button type="button">remove</button>');
        $removeButton.click(function()
        {
          $(this).parent().remove();
        });
        $li.append($removeButton);
        $ol.append($li);
      }

      $('#open-test-case-add-button').click(function()
      {
        addOpenTestCase();
      });

      $('#run-button').click(function()
      {
        if ($('#open-test-case-list li').length === 0)
        {
          alert('no test cases');
          return;
        }

        const openTestCases = $('#open-test-case-list li').map((i,li) => ({ input: $(li).find('.input').val().trimEnd(), output: $(li).find('.output').val().trimEnd() })).toArray();
        const randomTestCaseCode = randomTestCaseEditor.getValue().trim();
        const code = solutionEditor.getValue();
        let solutionResult = '';

        function runTestCase(type, testCase, testCaseNumber)
        {
          let output = '';
          
          const inputs = testCase.input.split(/\r+\n/);
          let currentInputIndex = -1;
          function readline()
          {
            if (++currentInputIndex < inputs.length)
            {
              return inputs[currentInputIndex];
            }

            return '';
          }

          function print(msg)
          {
            output += msg.toString() + '\n';
          }
          
          const editedCode = code
            .replace(/(?<!\.)readline/, 'arguments[0]')
            .replace(/(?<!\.)print/, 'arguments[1]');
          const codeFunction = new Function(editedCode);
          solutionResult += `--- ${type} #${testCaseNumber} ---\n`;
          try
          {
            codeFunction.apply(null, [readline, print]);
          }
          catch(e)
          {
            solutionResult += 'Failed.\n';
            solutionResult += e.toString();
            return false;
          }

          output = output.trimEnd();
          if (output == testCase.output)
          {
            solutionResult += 'Success.\n\n';
          }
          else
          {
            solutionResult += 'We expected...\n';
            solutionResult += testCase.output;
            solutionResult += '\nBut Your answer is...\n';
            solutionResult += output ? output : "'#empty'";
            solutionResult += '\nThe input is...\n';
            solutionResult += testCase.input;

            return false;
          }

          return true;
        }

        let openTestCaseSuccess = true;
        for (let i = 0; i < openTestCases.length; i++)
        {
          const testCase = openTestCases[i];
          const result = runTestCase('Open Test Case', testCase, i+1);
          if (!result)
          {
            openTestCaseSuccess = false;
            break;
          }
        }

        if (openTestCaseSuccess && randomTestCaseCode.length > 0)
        {
          const editedrandomTestCaseCode = randomTestCaseCode
            .replace(/(?<!\.)printInput/, 'arguments[0]')
            .replace(/(?<!\.)printOutput/, 'arguments[1]');
          const randomTestCaseMakerFunction = new Function(editedrandomTestCaseCode);

          for (let i = 1; i <= 100; i++)
          {
            const inputLines = [];
            function printInput(line)
            {
              inputLines.push(line);
            }

            const outputLines = [];
            function printOutput(line)
            {
              outputLines.push(line);
            }

            randomTestCaseMakerFunction.apply(null, [printInput, printOutput]);
            const testCase = {
              input: inputLines.join('\n'),
              output: outputLines.join('\n')
            };
            
            const result = runTestCase('Random Test Case', testCase, i);
            if (!result)
            {
              break;
            }
          }
        }

        $('#solution-result').val(solutionResult);
      });

      $('#problem-load-button').click(function()
      {
        const json = $('#problem-input').val();
        const problem = JSON.parse(json);
        
        $('input[name=title]').val(problem.title??'');
        $('#content-editor').toastuiEditor('setMarkdown', problem.content??'');
        problem.openTestCases.forEach(testCase =>
        {
          addOpenTestCase(testCase.input, testCase.output);
        });
        solutionEditor.setValue(problem.solution??'');
        randomTestCaseEditor.setValue(problem.randomTestCase??'');
      })

      $('#problem-make-button').click(function()
      {
        const problem = {
          title: $('input[name=title]').val(),
          content: $('#content-editor').toastuiEditor('getMarkdown'),
          openTestCases: $('#open-test-case-list li').map((i,li) => ({ input: $(li).find('.input').val().trimEnd(), output: $(li).find('.output').val().trimEnd() })).toArray(),
          randomTestCase: randomTestCaseEditor.getValue(),
          solution: solutionEditor.getValue()
        };
        $('#problem-output').val(JSON.stringify(problem));
      })

      window.addEventListener('beforeunload', function(e)
      {
        e.preventDefault();
        e.returnValue = '';
      });
    })
  </script>
</body>
</html>