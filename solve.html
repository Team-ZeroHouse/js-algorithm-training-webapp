<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JS 알고리즘 트레이닝</title>
</head>
<body>
  <h1>JS 알고리즘 트레이닝</h1>
  <h2 id="title"></h2>

  <h2>문제 설명</h2>
  <div id="content-viewer" style="border: 1px solid black;"></div>

  <h2>문제 작성</h2>
  <p>
    <strong>readline()</strong>으로 한줄 입력 받고<br />
    <strong>print()</strong>로 한줄 출력하세요.
  </p>
  <div id="editor" style="width: 600px; height: 400px; border: 1px solid black;"></div>

  <h3>테스트 케이스 <button id="run-all-button" type="button">테스트 모두 돌리기</button></h3>
  <ol id="test-case-list"></ol>

  <div>
    <button id="solve-button" type="button">최종 채점</button>
    <button id="show-solution-button" type="button">모르겠어요 ㅠ 답안보여줘요.</button>
  </div>

  <textarea id="output" readonly style="width: 600px; height: 200px; border: 1px solid black;"></textarea>

  <script src="jquery-3.5.1.min.js"></script>
  <script src="toast/toastui-jquery-editor-viewer.min.js"></script>
  <script src="vs/loader.js"></script>
  
  <script>
    let theProblem;
    let editor;

    function test(testCase)
    {
      let solutionResult = '';
      let output = '';
      
      const inputs = testCase.input.split(/\r+\n/);
      let currentInputIndex = -1;
      function readline()
      {
        if (++currentInputIndex < inputs.length)
        {
          return inputs[currentInputIndex];
        }

        return '';
      }

      function print(msg)
      {
        output += msg.toString() + '\n';
      }
      
      const editedCode = editor.getValue()
        .replace(/(?<!\.)readline/, 'arguments[0]')
        .replace(/(?<!\.)print/, 'arguments[1]');
      const codeFunction = new Function(editedCode);
      try
      {
        codeFunction.apply(null, [readline, print]);
      }
      catch(e)
      {
        solutionResult += 'Failed.\n';
        solutionResult += e.toString();
        return solutionResult;
      }

      output = output.trimEnd();
      if (output == testCase.output)
      {
        solutionResult += 'Success.\n\n';
      }
      else
      {
        solutionResult += 'We expected...\n';
        solutionResult += testCase.output;
        solutionResult += '\nBut Your answer is...\n';
        solutionResult += output ? output : "'#empty'";
      }

      return solutionResult;
    }
    
    function addTextCase(testCase)
    {
      const $li = $(`
      <li>
        <textarea class="input" readonly style="width: 300px; height: 100px;">${testCase.input}</textarea>
        <textarea class="output" readonly style="width: 300px; height: 100px;">${testCase.output}</textarea>
        <button type="button">Run</button>
        <textarea class="result" readonly style="width: 300px; height: 100px;"></textarea>
      </li>
      `);
      $li.find('button').click(function()
      {
        const result = test(testCase);
        $li.find('.result').val(result);
      });
      $('#test-case-list').append($li);
    }

    function loadedProblem(problem)
    {
      theProblem = problem;

      $('#title').val(problem.title??'');
      $('#content-viewer').toastuiEditor('setMarkdown', problem.content??'');
      problem.testCases.forEach(testCase =>
      {
        addTextCase(testCase);
      });
    }

    $(function()
    {
      const keyValues = location.href.substring(location.href.indexOf('?')+1).split('&').map(function(p) {
        const keyValue = p.split('=');
        return {
          key: keyValue[0],
          value: keyValue[1]
        };
      });
      const query = {};
      keyValues.forEach(function(pair) {
        query[pair.key] = pair.value;
      });

      const s = document.createElement('script');
      s.src = `problems-packs/${query.pack}/${query.level}/${query.problem}.js`;
      document.body.appendChild(s);

      $('#content-viewer').toastuiEditor();

      require.config({ paths: { vs: 'vs' } });
      require(['vs/editor/editor.main'], function()
      {
        editor = monaco.editor.create(
          document.getElementById('editor'),
          {
            language: 'javascript'
          }
        )
      });

      $('#show-solution-button').click(function()
      {
        if (confirm('진짜 볼꺼에요?'))
        {
          $('#output').val(theProblem.solution);
        }
      });

      $('#run-all-button').click(function()
      {
        $('#test-case-list button').click();
      });

      $('#solve-button').click(function()
      {
        $('#run-all-button').click();
        const failCount = $('#test-case-list .result').filter((i,x) => x.value.trim() !== 'Success.').length;
        if (failCount > 0)
        {
          $('#output').val('테스트 케이스 통과 실패');
          return;
        }
        
        $('#output').val('테스트 케이스 통과');

        // TODO: 문제 출제 시 랜덤 test case 만드는 함수 추가해서 100개 정도 돌리게 할 것
      });

      window.addEventListener('beforeunload', function(e)
      {
        e.preventDefault();
        e.returnValue = '';
      });
    });
  </script>
</body>
</html>